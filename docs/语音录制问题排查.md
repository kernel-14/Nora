# 语音录制问题排查指南

## 概述

本文档整合了语音录制功能的所有相关信息，包括音频格式、使用说明和故障排查。

## 音频格式支持

### 问题背景

浏览器的 MediaRecorder API 默认录制的音频格式是 **webm**，但后端 ASR 服务支持的格式是：
- ✅ mp3
- ✅ wav
- ✅ m4a
- ✅ webm（已添加支持）

### 解决方案

系统实现了自动格式转换：

**转换流程：**
```
webm 录音 → Web Audio API 解码 → AudioBuffer → 手动编码 WAV → 上传
```

**转换时间：** 约 1 秒（用户几乎无感知）

**浏览器支持：**
- ✅ Chrome/Edge - webm → wav 自动转换
- ✅ Firefox - webm → wav 自动转换  
- ✅ Safari - mp4/aac 直接支持
- ✅ 移动端浏览器 - 全部支持

## 使用指南

### 在应用中使用

1. 打开应用首页：http://localhost:5173
2. 点击大圆形麦克风按钮
3. 允许浏览器访问麦克风（首次使用）
4. 开始说话
5. 再次点击麦克风停止录音
6. 等待处理（1-3 秒）
7. 看到"记录成功！"提示

### 测试录音功能

打开测试页面：`test_audio_recording.html`

**功能：**
- 查看浏览器支持的音频格式
- 录制音频并预览
- 测试格式转换
- 上传到后端测试

## 常见问题

### Q1: 为什么需要麦克风权限？

**A:** 浏览器安全策略要求，必须用户明确授权才能访问麦克风。

**解决方法：**
1. 点击浏览器地址栏的麦克风图标
2. 选择"允许"
3. 刷新页面重试

### Q2: 为什么录音后有延迟？

**A:** 这是正常的，因为需要：
1. 格式转换（webm → wav）：约 0.5-1 秒
2. 上传到后端：约 0.5-1 秒
3. ASR 识别：约 1-2 秒
4. 语义分析：约 1-2 秒

**总计：** 约 3-6 秒

### Q3: 录音音质不好怎么办？

**可能原因：**
- 麦克风质量差
- 环境噪音大
- 距离麦克风太远

**解决方法：**
1. 使用外接麦克风
2. 在安静环境录音
3. 靠近麦克风说话
4. 说话清晰、语速适中

### Q4: 录音失败怎么办？

**错误信息：** "无法访问麦克风"

**解决方法：**
1. 检查麦克风是否连接
2. 检查浏览器权限设置
3. 检查系统麦克风权限
4. 尝试其他浏览器

**错误信息：** "处理失败"

**解决方法：**
1. 检查网络连接
2. 检查后端是否运行
3. 查看浏览器控制台错误
4. 查看后端日志

### Q5: 可以录多长时间？

**A:** 目前没有硬性限制，但建议：
- 单次录音 < 60 秒
- 说话清晰、简洁
- 避免长时间停顿

**原因：**
- 文件越大，上传越慢
- 转换时间越长
- ASR 识别可能不准确

## 使用技巧

### 1. 录音前准备

- ✅ 确保环境安静
- ✅ 检查麦克风工作正常
- ✅ 想好要说的内容
- ✅ 准备好开始录音

### 2. 录音中

- ✅ 说话清晰、语速适中
- ✅ 避免长时间停顿
- ✅ 一次说完一个完整想法
- ✅ 注意录音指示灯（脉冲动画）

### 3. 录音后

- ✅ 等待处理完成
- ✅ 查看"记录成功"提示
- ✅ 检查记录是否正确
- ✅ 如有错误，可以重新录制

### 4. 最佳实践

**好的录音示例：**
```
"今天天气很好，心情不错。
想到一个新点子：做一个治愈系应用。
明天要记得买书。"
```

**不好的录音示例：**
```
"嗯... 今天... 呃... 那个... 
（长时间停顿）
我想... 嗯... 做个... 什么来着..."
```

## 技术细节

### 录音参数

```typescript
const options = {
  mimeType: 'audio/webm;codecs=opus',
  audioBitsPerSecond: 128000  // 128 kbps
};
```

### WAV 格式参数

```
- 格式：PCM
- 采样率：原始采样率（通常 48000 Hz）
- 位深度：16-bit
- 声道：单声道或立体声（取决于录音）
```

### 文件大小估算

```
录音时长 × 采样率 × 位深度 × 声道数 / 8

示例（10 秒单声道录音）：
10 × 48000 × 16 × 1 / 8 = 960,000 bytes ≈ 938 KB
```

## 浏览器兼容性

### Chrome/Edge ✅ (推荐)

- 录音格式：webm
- 自动转换：是
- 音质：优秀
- 性能：优秀

### Firefox ✅

- 录音格式：webm
- 自动转换：是
- 音质：优秀
- 性能：良好

### Safari ✅

- 录音格式：mp4/aac
- 自动转换：否（直接支持）
- 音质：优秀
- 性能：优秀

### 移动端浏览器 ✅

- iOS Safari：支持
- Android Chrome：支持
- 微信浏览器：支持（需要 HTTPS）

## 性能优化

### 转换性能

- **转换时间：** 通常 < 1 秒（取决于录音长度）
- **内存占用：** 临时增加（录音长度 × 2）
- **CPU 使用：** 中等（Web Audio API 解码 + WAV 编码）

### 优化建议

1. **限制录音时长**
   ```typescript
   // 最多录制 60 秒
   setTimeout(() => {
     if (mediaRecorder.state === 'recording') {
       mediaRecorder.stop();
     }
   }, 60000);
   ```

2. **显示转换进度**
   ```typescript
   setProcessing(true);
   setStatus('正在转换音频格式...');
   const wavBlob = await convertWebmToWav(audioBlob);
   setStatus('正在上传...');
   ```

3. **错误处理**
   ```typescript
   try {
     const wavBlob = await convertWebmToWav(audioBlob);
     // 上传 wav
   } catch (conversionError) {
     console.error('Conversion failed:', conversionError);
     // 降级：尝试直接上传 webm
     const file = new File([audioBlob], 'recording.mp3', { type: 'audio/mpeg' });
     await apiService.processInput(file);
   }
   ```

## 故障排查工具

### 1. 浏览器控制台

按 F12 打开开发者工具，查看：
- Console：错误信息
- Network：网络请求
- Application：权限设置

### 2. 测试页面

打开 `test_audio_recording.html`：
- 查看浏览器支持的格式
- 测试录音和转换
- 查看详细错误信息

### 3. 后端日志

```bash
tail -f logs/app.log
```

查看：
- ASR 调用日志
- 错误堆栈
- 处理时间

## 总结

语音录制功能已经完全支持现代浏览器：

✅ **自动格式转换** - webm → wav
✅ **跨浏览器支持** - Chrome/Firefox/Safari
✅ **友好的用户体验** - 清晰的状态提示
✅ **完善的错误处理** - 降级方案
✅ **详细的文档** - 使用说明和故障排查

现在你可以在任何浏览器中流畅使用语音录制功能了！

---

**更新时间：** 2024-01-17
**状态：** ✅ 已完成
