# 心情气泡池功能说明

## 概述

心情气泡池是一个基于 **Matter.js 物理引擎**的动态可视化界面，将用户的心情记录转化为可交互的彩色气泡，在屏幕内自由漂浮并发生真实的物理碰撞。

## 核心特性

### 1. 物理引擎驱动
- **引擎**: Matter.js
- **重力**: 极轻微的向下重力 (0.05)
- **碰撞**: 真实的物理反弹效果
- **弹性系数**: 0.6（柔和的水滴质感）
- **空气阻力**: 0.02（自然的减速效果）
- **布朗运动**: 随机微小扰动，模拟自然漂浮

### 2. 数据驱动

#### 数据来源
- 从 `moods.json` 读取心情记录
- 只显示**最近 7 天**的心情数据
- 实时从后端 API 获取: `/api/moods`

#### 数据映射

| 数据字段 | 视觉映射 | 说明 |
|---------|---------|------|
| `type` | 气泡颜色 + 中心文字 | 心情类型（喜悦、焦虑、平静等） |
| `intensity` | 气泡大小 | 1-10 的强度值，映射到 25-60px 半径 |
| `keywords` | 详情弹窗 | 点击气泡显示关键词标签 |
| `timestamp` | 详情弹窗 | 显示记录时间 |

### 3. 颜色映射表

| 心情类型 | 填充色 | 边框色 | 光晕色 | 说明 |
|---------|--------|--------|--------|------|
| 喜悦 | 暖橙色 (#FED7AA) | #FB923C | rgba(251,146,60,0.4) | 温暖明亮 |
| 开心 | 粉红色 (#FECACA) | #FB7185 | rgba(251,113,133,0.4) | 活泼可爱 |
| 兴奋 | 亮黄色 (#FEF08A) | #FACC15 | rgba(250,204,21,0.4) | 充满活力 |
| 平静 | 天蓝色 (#BFDBFE) | #60A5FA | rgba(96,165,250,0.4) | 宁静舒适 |
| 放松 | 青绿色 (#D9F99D) | #84CC16 | rgba(132,204,22,0.4) | 自然清新 |
| 焦虑 | 淡紫色 (#DDD6FE) | #A78BFA | rgba(167,139,250,0.4) | 柔和梦幻 |
| 悲伤 | 灰蓝色 (#CBD5E1) | #64748B | rgba(100,116,139,0.4) | 低调沉静 |
| 疲惫 | 浅紫色 (#E0E7FF) | #818CF8 | rgba(129,140,248,0.4) | 柔和朦胧 |

### 4. 视觉效果

#### 毛玻璃质感
- **半透明渐变**: 使用 CSS 渐变色
- **光晕效果**: 径向渐变，透明度 0.3
- **高光**: 左上角白色高光点，模拟光泽

#### 动画效果
- **漂浮**: 气泡在容器内自由移动
- **碰撞**: 气泡相互碰撞时产生真实反弹
- **拖拽**: 鼠标可以拖动气泡
- **布朗运动**: 每 100ms 施加随机微小力

### 5. 交互功能

#### 点击气泡
- 显示详情弹窗
- 包含信息：
  - 心情类型（大标题）
  - 情绪强度（进度条）
  - 关键词标签
  - 记录时间

#### 拖拽气泡
- 鼠标按住气泡可拖动
- 释放后气泡继续物理运动
- 拖动时其他气泡会被推开

#### 边界限制
- 气泡被限制在容器内
- 碰到边界会反弹
- 不会跑出屏幕

## 技术实现

### 组件结构

```
MoodView.tsx (主容器)
  └── PhysicsMoodBubble.tsx (物理引擎组件)
        ├── Matter.js Engine (物理引擎)
        ├── Matter.js Render (渲染器)
        ├── Matter.js Bodies (气泡实体)
        └── Matter.js MouseConstraint (鼠标交互)
```

### 关键代码

#### 创建气泡
```typescript
const radius = 25 + (mood.intensity / 10) * 35; // 大小映射
const body = Matter.Bodies.circle(x, y, radius, {
  restitution: 0.6,  // 弹性
  friction: 0.01,    // 摩擦
  frictionAir: 0.02, // 空气阻力
  density: 0.001     // 密度
});
```

#### 自定义渲染
```typescript
Matter.Events.on(render, 'afterRender', () => {
  // 绘制光晕
  // 绘制高光
  // 绘制文字
});
```

#### 布朗运动
```typescript
setInterval(() => {
  bodies.forEach(({ body }) => {
    Matter.Body.applyForce(body, body.position, {
      x: (Math.random() - 0.5) * 0.0001,
      y: (Math.random() - 0.5) * 0.0001
    });
  });
}, 100);
```

## 性能优化

### 数据过滤
- 只显示最近 7 天的心情
- 避免气泡过多导致性能问题
- 建议最多显示 20-30 个气泡

### 渲染优化
- 使用 Canvas 渲染，性能优于 DOM
- 物理引擎在独立线程运行
- 自定义渲染只在必要时执行

### 内存管理
- 组件卸载时清理物理引擎
- 清除所有事件监听器
- 释放 Canvas 资源

## 测试

### 测试页面
打开 `frontend/test-physics-mood.html` 可以独立测试物理引擎效果。

### 测试要点
1. ✅ 气泡是否正常显示
2. ✅ 气泡是否会碰撞反弹
3. ✅ 是否可以拖动气泡
4. ✅ 点击是否显示详情
5. ✅ 气泡是否被限制在容器内
6. ✅ 颜色映射是否正确
7. ✅ 大小是否与强度对应

## 未来优化方向

### 功能增强
- [ ] 添加心情筛选（按类型、时间）
- [ ] 支持气泡合并（相同心情）
- [ ] 添加心情趋势分析
- [ ] 支持导出心情数据

### 视觉优化
- [ ] 更多心情类型和颜色
- [ ] 气泡动画效果（呼吸、闪烁）
- [ ] 背景粒子效果
- [ ] 主题切换（日间/夜间）

### 交互优化
- [ ] 双击气泡编辑
- [ ] 长按删除气泡
- [ ] 手势缩放容器
- [ ] 气泡分组显示

## 常见问题

### Q: 气泡重叠怎么办？
A: 初始位置采用圆形分布，避免重叠。如果仍有重叠，物理引擎会自动推开。

### Q: 气泡跑出屏幕？
A: 已添加不可见边界墙，气泡会被限制在容器内。

### Q: 动画卡顿？
A: 检查气泡数量，建议不超过 30 个。可以调整时间范围过滤。

### Q: 颜色不对？
A: 检查 `getMoodColor` 函数的颜色映射表，确保心情类型匹配。

## 相关文件

- `frontend/components/MoodView.tsx` - 主视图组件
- `frontend/components/PhysicsMoodBubble.tsx` - 物理引擎组件
- `frontend/test-physics-mood.html` - 独立测试页面
- `data/moods.json` - 心情数据文件
- `app/main.py` - 后端 API (`/api/moods`)

## 依赖

- `matter-js`: ^0.20.0 - 物理引擎
- `@types/matter-js`: ^0.20.2 - TypeScript 类型定义
- `react`: ^19.2.3
- `lucide-react`: ^0.562.0 - 图标库
