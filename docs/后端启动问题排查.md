# 后端启动问题排查指南

## 问题：ModuleNotFoundError: No module named 'app'

### 错误信息
```
ModuleNotFoundError: No module named 'app'
```

### 原因分析

这个错误通常由以下原因引起：

1. **在错误的目录运行命令**
   - 必须在项目根目录运行
   - 不能在 `app/` 目录内运行

2. **Python 路径问题**
   - Python 找不到 `app` 模块
   - PYTHONPATH 未正确设置

3. **虚拟环境问题**
   - 未激活正确的虚拟环境
   - 依赖未安装

## 解决方案

### 方案 1：使用启动脚本（推荐）

**Windows CMD:**
```bash
启动后端.bat
```

**PowerShell:**
```bash
.\启动后端.ps1
```

这些脚本会：
- ✅ 检查当前目录是否正确
- ✅ 自动激活虚拟环境
- ✅ 使用正确的命令启动

### 方案 2：手动启动

#### 步骤 1：确认在项目根目录

```bash
# 检查当前目录
pwd

# 应该看到这些文件/目录
ls
# app/
# frontend/
# data/
# requirements.txt
# README.md
```

#### 步骤 2：激活虚拟环境（如果有）

**Windows:**
```bash
# CMD
venv\Scripts\activate.bat

# PowerShell
venv\Scripts\Activate.ps1
```

**Linux/Mac:**
```bash
source venv/bin/activate
```

#### 步骤 3：启动服务器

**使用 python -m（推荐）:**
```bash
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

**或者直接使用 uvicorn:**
```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 方案 3：不使用 reload 模式

如果 `--reload` 参数导致问题，可以不使用：

```bash
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

**注意：** 不使用 reload 模式时，修改代码后需要手动重启服务器。

### 方案 4：设置 PYTHONPATH

如果上述方法都不行，手动设置 PYTHONPATH：

**Windows CMD:**
```bash
set PYTHONPATH=%CD%
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

**PowerShell:**
```powershell
$env:PYTHONPATH = $PWD
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

**Linux/Mac:**
```bash
export PYTHONPATH=$PWD
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

## 验证步骤

### 1. 检查目录结构

```bash
# 应该看到这个结构
项目根目录/
├── app/
│   ├── __init__.py
│   ├── main.py
│   ├── config.py
│   └── ...
├── frontend/
├── data/
└── requirements.txt
```

### 2. 检查 Python 环境

```bash
# 检查 Python 版本
python --version
# 应该是 Python 3.8+

# 检查 uvicorn 是否安装
python -c "import uvicorn; print(uvicorn.__version__)"
# 应该显示版本号

# 检查 FastAPI 是否安装
python -c "import fastapi; print(fastapi.__version__)"
# 应该显示版本号
```

### 3. 测试导入

```bash
# 测试能否导入 app 模块
python -c "import app.main; print('OK')"
# 应该显示 OK
```

如果这一步失败，说明模块路径有问题。

### 4. 检查依赖

```bash
# 安装/更新依赖
pip install -r requirements.txt

# 或者单独安装
pip install fastapi uvicorn python-multipart httpx pydantic
```

## 常见错误和解决方法

### 错误 1：在 app/ 目录内运行

**错误操作：**
```bash
cd app
python -m uvicorn main:app --reload
```

**正确操作：**
```bash
# 回到项目根目录
cd ..
python -m uvicorn app.main:app --reload
```

### 错误 2：虚拟环境未激活

**症状：**
- 提示找不到 uvicorn
- 提示找不到 fastapi

**解决：**
```bash
# 激活虚拟环境
venv\Scripts\activate.bat  # Windows CMD
venv\Scripts\Activate.ps1  # PowerShell
source venv/bin/activate    # Linux/Mac

# 然后重新启动
python -m uvicorn app.main:app --reload
```

### 错误 3：端口被占用

**错误信息：**
```
OSError: [Errno 48] Address already in use
```

**解决方法：**

**方法 1：使用其他端口**
```bash
python -m uvicorn app.main:app --port 8001
```

**方法 2：关闭占用端口的进程**

Windows:
```bash
# 查找占用 8000 端口的进程
netstat -ano | findstr :8000

# 关闭进程（替换 PID）
taskkill /PID <PID> /F
```

Linux/Mac:
```bash
# 查找并关闭
lsof -ti:8000 | xargs kill -9
```

### 错误 4：权限问题

**错误信息：**
```
PermissionError: [Errno 13] Permission denied
```

**解决方法：**

1. 以管理员身份运行
2. 检查文件权限
3. 使用其他端口（> 1024）

## 推荐的启动方式

### 开发环境

**方式 1：使用启动脚本**
```bash
# Windows
启动后端.bat

# PowerShell
.\启动后端.ps1
```

**方式 2：手动启动（带 reload）**
```bash
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 生产环境

**使用 gunicorn（Linux）:**
```bash
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

**使用 uvicorn（Windows）:**
```bash
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
```

## 调试技巧

### 1. 查看详细日志

```bash
python -m uvicorn app.main:app --log-level debug
```

### 2. 检查配置

```bash
# 查看环境变量
python -c "from app.config import get_config; print(get_config())"
```

### 3. 测试 API

```bash
# 启动后测试
curl http://localhost:8000/health

# 或在浏览器访问
http://localhost:8000/docs
```

## 完整的启动检查清单

- [ ] 在项目根目录（不是 app/ 目录）
- [ ] 虚拟环境已激活（如果使用）
- [ ] 依赖已安装（pip install -r requirements.txt）
- [ ] .env 文件已配置
- [ ] 端口 8000 未被占用
- [ ] Python 版本 >= 3.8
- [ ] 可以导入 app 模块（python -c "import app.main"）

## 快速诊断命令

运行这个命令进行快速诊断：

```bash
python -c "
import sys
import os
print('Python 版本:', sys.version)
print('当前目录:', os.getcwd())
print('app 目录存在:', os.path.exists('app'))
print('main.py 存在:', os.path.exists('app/main.py'))
try:
    import uvicorn
    print('uvicorn 已安装:', uvicorn.__version__)
except:
    print('uvicorn 未安装')
try:
    import fastapi
    print('fastapi 已安装:', fastapi.__version__)
except:
    print('fastapi 未安装')
try:
    import app.main
    print('app.main 可导入: OK')
except Exception as e:
    print('app.main 导入失败:', e)
"
```

## 总结

最常见的问题是**在错误的目录运行命令**。

**解决方法：**
1. 确保在项目根目录
2. 使用提供的启动脚本
3. 使用 `python -m uvicorn` 而不是直接 `uvicorn`

如果问题仍然存在，请：
1. 运行快速诊断命令
2. 检查完整的启动检查清单
3. 查看详细的错误日志

---

**需要帮助？** 请提供：
- 完整的错误信息
- 当前目录（pwd）
- Python 版本（python --version）
- 快速诊断命令的输出
