# 首页交互功能架构图

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                         用户界面                              │
│                                                               │
│  ┌──────────────┐              ┌──────────────┐             │
│  │   首页记录    │              │   AI 对话     │             │
│  │              │              │              │             │
│  │  🎤 语音输入  │              │  💬 聊天界面  │             │
│  │  ⌨️  文字输入  │              │  📝 消息输入  │             │
│  └──────────────┘              └──────────────┘             │
│         │                              │                     │
└─────────┼──────────────────────────────┼─────────────────────┘
          │                              │
          ▼                              ▼
┌─────────────────────┐        ┌─────────────────────┐
│   /api/process      │        │   /api/chat         │
│                     │        │                     │
│  1. 接收输入        │        │  1. 接收消息        │
│  2. ASR 转文字      │        │  2. 加载历史记录    │
│  3. 语义分析        │        │  3. 构建 RAG 上下文 │
│  4. 保存记录        │        │  4. 调用 AI API     │
│  5. 拆分分类        │        │  5. 返回回复        │
└─────────────────────┘        └─────────────────────┘
          │                              │
          ▼                              │
┌─────────────────────┐                  │
│   数据存储           │◄─────────────────┘
│                     │     (读取历史)
│  📄 records.json    │
│  😊 moods.json      │
│  💡 inspirations.json│
│  ✅ todos.json       │
└─────────────────────┘
```

## 首页记录流程

```
用户输入
   │
   ├─ 语音 ──► MediaRecorder ──► Blob ──► File
   │                                        │
   └─ 文字 ─────────────────────────────────┤
                                            │
                                            ▼
                                    FormData (audio/text)
                                            │
                                            ▼
                                    POST /api/process
                                            │
                    ┌───────────────────────┴───────────────────────┐
                    │                                               │
                    ▼                                               ▼
            audio != null?                                   text != null?
                    │                                               │
                    ▼                                               │
            ASR Service (智谱 AI)                                   │
                    │                                               │
                    └───────────────────┬───────────────────────────┘
                                        │
                                        ▼
                                  original_text
                                        │
                                        ▼
                            Semantic Parser (GLM-4-Flash)
                                        │
                    ┌───────────────────┼───────────────────┐
                    │                   │                   │
                    ▼                   ▼                   ▼
                  mood              inspirations          todos
                    │                   │                   │
                    └───────────────────┴───────────────────┘
                                        │
                                        ▼
                                Storage Service
                                        │
                    ┌───────────────────┼───────────────────┐
                    │                   │                   │
                    ▼                   ▼                   ▼
              moods.json        inspirations.json      todos.json
                    │                   │                   │
                    └───────────────────┴───────────────────┘
                                        │
                                        ▼
                                records.json (完整记录)
                                        │
                                        ▼
                                返回 ProcessResponse
                                        │
                                        ▼
                                前端显示"记录成功"
```

## AI 对话流程（RAG 增强）

```
用户消息
   │
   ▼
POST /api/chat
   │
   ├─ text: "我最近在做什么？"
   │
   ▼
Storage Service
   │
   ├─ 读取 records.json
   │
   ▼
recent_records = records[-10:]  (最近 10 条)
   │
   ▼
构建上下文
   │
   ├─ for each record:
   │    ├─ 提取 original_text
   │    ├─ 提取 mood (type, intensity)
   │    ├─ 提取 inspirations (core_idea)
   │    └─ 提取 todos (task)
   │
   ▼
context_text = """
[2024-01-17T10:00:00Z] 用户说: 今天工作很累
情绪: 疲惫 (强度: 7)
待办: 明天早起跑步

[2024-01-17T14:00:00Z] 用户说: 完成了项目很开心
情绪: 开心 (强度: 8)
灵感: 项目完成的成就感
...
"""
   │
   ▼
system_prompt = f"""
你是一个温柔、善解人意的AI陪伴助手。
你可以参考用户的历史记录来提供更贴心的回复：

{context_text}

请基于这些背景信息，用温暖、理解的语气回复用户。
"""
   │
   ▼
GLM-4-Flash API
   │
   ├─ model: "glm-4-flash"
   ├─ messages: [
   │    {role: "system", content: system_prompt},
   │    {role: "user", content: "我最近在做什么？"}
   │  ]
   ├─ temperature: 0.8
   └─ top_p: 0.9
   │
   ▼
AI 生成回复
   │
   ├─ "从你的记录来看，你最近在忙一个项目，
   │    虽然工作很累，但完成后很有成就感呢！
   │    你还计划明天早起去跑步，保持健康的习惯真棒！"
   │
   ▼
返回 {response: "..."}
   │
   ▼
前端显示 AI 回复
```

## 数据流向

```
┌─────────────┐
│  用户输入    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ HomeInput   │ (前端组件)
│ Component   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ API Service │ (前端服务层)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ FastAPI     │ (后端 API)
│ /api/process│
└──────┬──────┘
       │
       ├─► ASR Service ──► 智谱 AI (语音转文字)
       │
       ├─► Semantic Parser ──► GLM-4-Flash (语义分析)
       │
       └─► Storage Service ──► JSON 文件 (数据存储)
                                    │
                                    ├─► records.json
                                    ├─► moods.json
                                    ├─► inspirations.json
                                    └─► todos.json
```

## RAG 知识库结构

```
records.json (知识库)
│
├─ Record 1
│  ├─ record_id: "uuid-1"
│  ├─ timestamp: "2024-01-17T10:00:00Z"
│  ├─ original_text: "今天工作很累"
│  └─ parsed_data:
│     ├─ mood: {type: "疲惫", intensity: 7}
│     ├─ inspirations: []
│     └─ todos: []
│
├─ Record 2
│  ├─ record_id: "uuid-2"
│  ├─ timestamp: "2024-01-17T14:00:00Z"
│  ├─ original_text: "完成了项目很开心"
│  └─ parsed_data:
│     ├─ mood: {type: "开心", intensity: 8}
│     ├─ inspirations: [{core_idea: "项目完成"}]
│     └─ todos: []
│
└─ Record 3
   ├─ record_id: "uuid-3"
   ├─ timestamp: "2024-01-17T18:00:00Z"
   ├─ original_text: "明天要早起跑步"
   └─ parsed_data:
      ├─ mood: null
      ├─ inspirations: []
      └─ todos: [{task: "早起跑步", time: "明天"}]

                    ↓ (RAG 提取)

AI 对话上下文:
"""
[2024-01-17T10:00:00Z] 用户说: 今天工作很累
情绪: 疲惫 (强度: 7)

[2024-01-17T14:00:00Z] 用户说: 完成了项目很开心
情绪: 开心 (强度: 8)
灵感: 项目完成

[2024-01-17T18:00:00Z] 用户说: 明天要早起跑步
待办: 早起跑步
"""
```

## 组件关系图

```
App.tsx
   │
   ├─► HomeInput.tsx (首页输入)
   │   │
   │   ├─► VoiceRecording (语音录制)
   │   │   └─► MediaRecorder API
   │   │
   │   ├─► TextInput (文字输入)
   │   │   └─► Input Element
   │   │
   │   └─► apiService.processInput()
   │       └─► POST /api/process
   │
   ├─► MoodView.tsx (心情页面)
   │   └─► ChatDialog.tsx
   │       └─► apiService.chatWithAI()
   │           └─► POST /api/chat (RAG)
   │
   ├─► InspirationView.tsx (灵感页面)
   │   └─► ChatDialog.tsx
   │       └─► apiService.chatWithAI()
   │           └─► POST /api/chat (RAG)
   │
   └─► TodoView.tsx (待办页面)
       └─► ChatDialog.tsx
           └─► apiService.chatWithAI()
               └─► POST /api/chat (RAG)
```

## API 端点对比

```
┌─────────────────────────────────────────────────────────────┐
│                      /api/process                            │
├─────────────────────────────────────────────────────────────┤
│ 输入: audio (File) 或 text (string)                          │
│ 处理:                                                        │
│   1. ASR 转文字 (如果是音频)                                 │
│   2. 语义分析 (GLM-4-Flash)                                  │
│   3. 保存到 records.json                                     │
│   4. 拆分到 moods/inspirations/todos.json                    │
│ 输出: ProcessResponse {                                      │
│   record_id, timestamp, mood, inspirations, todos            │
│ }                                                            │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                      /api/chat                               │
├─────────────────────────────────────────────────────────────┤
│ 输入: text (string)                                          │
│ 处理:                                                        │
│   1. 加载 records.json (最近 10 条)                          │
│   2. 提取情绪、灵感、待办信息                                │
│   3. 构建 RAG 上下文                                         │
│   4. 调用 GLM-4-Flash API                                    │
│   5. 生成个性化回复                                          │
│ 输出: {                                                      │
│   response: "AI 的回复内容"                                  │
│ }                                                            │
└─────────────────────────────────────────────────────────────┘
```

## 技术栈

```
前端
├─ React 19
├─ TypeScript
├─ Vite
├─ Tailwind CSS
└─ Lucide Icons

后端
├─ FastAPI
├─ Pydantic
├─ Uvicorn
├─ httpx (异步 HTTP)
└─ Python 3.8+

AI 服务
├─ 智谱 AI (ASR)
├─ GLM-4-Flash (语义分析)
└─ GLM-4-Flash (对话生成)

数据存储
└─ JSON 文件
   ├─ records.json
   ├─ moods.json
   ├─ inspirations.json
   └─ todos.json
```

## 性能优化点

```
前端优化
├─ 防抖处理 (输入延迟)
├─ 乐观更新 (立即反馈)
├─ 组件懒加载
└─ 缓存机制

后端优化
├─ 异步处理 (async/await)
├─ 连接池复用
├─ 限制历史记录数量 (10 条)
└─ 响应压缩

RAG 优化
├─ 只加载最近记录
├─ 精简上下文信息
├─ 缓存常见问题
└─ 向量数据库 (未来)
```

---

这个架构图展示了整个系统的工作流程和数据流向，帮助理解两种功能的区别和联系。
